name: Build kernels

on:
  push:
    branches:
      - sixteen   # yaap16 ÂàÜÊîØ
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel (Op7Series_KSU_Nethunter + LXC)
    runs-on: ubuntu-latest
    env:
      BUILD_DATE: ${{ github.run_id }}
      KERNEL_NAME: Op7Series_KSU_Nethunter
      KERNEL_REPO: https://github.com/yaap/kernel_oneplus_sm8150
      KERNEL_BRANCH: sixteen
      KERNEL_DEVICE: Oneplus7Series
      KERNEL_DEFCONFIG_PATH: gulch_defconfig
      ENABLE_CCACHE: true
      USE_ANYKERNEL3: true
      ENABLE_KERNELSU: true
      ENABLE_LXC: true
      OUT_DIR: ${{ github.workspace }}/out
      CCACHE_DIR: ${{ github.workspace }}/ccache
      ARCH: arm64
      CROSS_COMPILE: aarch64-linux-gnu-
      CROSS_COMPILE_ARM32: arm-linux-androideabi-

    steps:
      - name: Checkout Source
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            bc bison build-essential curl flex git wget ccache lftp \
            libssl-dev libelf-dev libncurses5-dev libncursesw5-dev \
            lib32z1 lib32ncurses6 lib32gcc-13-dev gcc-13-multilib \
            clang lld libglvnd-dev xsltproc

      - name: Setup ccache
        run: |
          if [ "${{ env.ENABLE_CCACHE }}" = "true" ]; then
            export PATH="${{ env.CCACHE_DIR }}/bin:$PATH"
            ccache -M 10G
          fi

      - name: Print PATH
        run: echo "ü§î PATH Variable: $PATH"

      - name: Kernel Configuration
        run: |
          echo "üîß Applying kernel defconfig: $KERNEL_DEFCONFIG_PATH"
          make -j$(nproc) O=${{ env.OUT_DIR }} ARCH=${{ env.ARCH }} \
            CC="ccache clang" CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            CROSS_COMPILE_ARM32=${{ env.CROSS_COMPILE_ARM32 }} \
            ${KERNEL_DEFCONFIG_PATH}

      - name: Build Kernel
        run: |
          echo "üöÄ Starting kernel build..."
          set -o pipefail
          make -j$(nproc) O=${{ env.OUT_DIR }} ARCH=${{ env.ARCH }} \
            CC="ccache clang" CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
            CROSS_COMPILE_ARM32=${{ env.CROSS_COMPILE_ARM32 }} \
            LD=ld.lld AR=llvm-ar NM=llvm-nm \
            OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump \
            READELF=llvm-readelf OBJSIZE=llvm-size \
            STRIP=llvm-strip LDGOLD=aarch64-linux-gnu-ld.gold \
            LLVM_AR=llvm-ar LLVM_DIS=llvm-dis CONFIG_THINLTO=y \
            2>&1 | tee build.log

      - name: Verify KernelSU & LXC
        run: |
          echo "üîç Checking KernelSU and LXC modules..."
          grep -q "CONFIG_KERN_SU=y" ${{ env.OUT_DIR }}/.config && echo "‚úÖ KernelSU enabled" || echo "‚ùå KernelSU NOT enabled"
          grep -q "CONFIG_LXC=y" ${{ env.OUT_DIR }}/.config && echo "‚úÖ LXC enabled" || echo "‚ùå LXC NOT enabled"

      - name: Save Build Artifacts
        if: always()
        run: |
          echo "üíæ Saving .config and modules for debugging"
          cp ${{ env.OUT_DIR }}/.config ${{ github.workspace }}/kernel-config-${{ github.run_id }}.txt
          tar -czf kernel-modules-${{ github.run_id }}.tar.gz -C ${{ env.OUT_DIR }} modules

      - name: Build AnyKernel3 Package
        if: env.USE_ANYKERNEL3 == 'true'
        run: |
          echo "üì¶ Building AnyKernel3 zip..."
          cd AnyKernel3
          zip -r ../${{ env.KERNEL_NAME }}-${{ github.run_id }}.zip . -x '*.git*'

      - name: Show Build Output
        run: tree -L 2 ${{ env.OUT_DIR }}
